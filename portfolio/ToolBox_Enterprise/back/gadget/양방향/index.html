<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ëŒ“ê¸€ ì‹œìŠ¤í…œ ëª©ì—…</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background: #f5f5f5;
            }

            .container {
                max-width: 600px;
                margin: 0 auto;
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            h1 {
                text-align: center;
                color: #333;
            }

            .comment-list {
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid #ddd;
                padding: 10px;
                margin-bottom: 15px;
                background: #f9f9f9;
            }

            .comment-item {
                border-bottom: 1px solid #eee;
                padding: 10px 0;
            }

            .comment-author {
                font-weight: bold;
                color: #007bff;
            }

            .comment-content {
                margin: 5px 0;
            }

            .comment-time {
                font-size: 12px;
                color: #666;
            }

            .form-group {
                margin-bottom: 10px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }

            .form-group input,
            .form-group textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }

            .form-group textarea {
                height: 80px;
                resize: vertical;
            }

            .btn {
                background: #007bff;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
            }

            .btn:hover {
                background: #0056b3;
            }

            .btn:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

            .refresh-btn {
                background: #28a745;
            }

            .error {
                color: #dc3545;
                font-size: 14px;
                margin-top: 5px;
            }

            .success {
                color: #28a745;
                font-size: 14px;
                margin-top: 5px;
            }

            .loading {
                color: #007bff;
                font-style: italic;
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 10px;
                margin-top: 15px;
            }

            .pagination button {
                padding: 5px 10px;
                border: 1px solid #ddd;
                background: white;
                cursor: pointer;
            }

            .pagination button:disabled {
                background: #f5f5f5;
                cursor: not-allowed;
            }

            .pagination-info {
                font-size: 14px;
                color: #666;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ëŒ“ê¸€ ì‹œìŠ¤í…œ ëª©ì—…</h1>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div id="commentList" class="comment-list">
                <div class="loading">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div
                id="commentPagination"
                class="pagination"
                style="display: none"
            >
                <button id="prevPage">ì´ì „</button>
                <span id="paginationInfo" class="pagination-info"
                    >1-10 / 0</span
                >
                <button id="nextPage">ë‹¤ìŒ</button>
            </div>

            <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
            <div>
                <div class="form-group">
                    <label for="commentName">ì´ë¦„ (ì„ íƒ):</label>
                    <input
                        type="text"
                        id="commentName"
                        placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                        maxlength="20"
                    />
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="anonymousCheck" /> ìµëª…ìœ¼ë¡œ
                        ì‘ì„±
                    </label>
                </div>

                <div class="form-group">
                    <label for="commentInput">ëŒ“ê¸€ ë‚´ìš©:</label>
                    <textarea
                        id="commentInput"
                        placeholder="í•¨ê»˜ ì´ì•¼ê¸°í•´ìš”:)"
                        maxlength="500"
                    ></textarea>
                    <div>ê¸€ì ìˆ˜: <span id="charCount">0</span>/500</div>
                </div>

                <div class="form-group">
                    <button id="submitComment" class="btn">ëŒ“ê¸€ ì‘ì„±</button>
                    <button id="refreshComments" class="btn refresh-btn">
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>

                <div id="message"></div>
            </div>
        </div>

        <script>
            // ===== ëŒ“ê¸€ ì‹œìŠ¤í…œ ëª©ì—… - Google Apps Script ì—°ë™ =====
            //
            // ğŸ¯ ëª©ì : ê°„ë‹¨í•œ ëŒ“ê¸€ ì‹œìŠ¤í…œìœ¼ë¡œ ì‹¤ì œ APIì™€ ì—°ë™ í…ŒìŠ¤íŠ¸
            //
            // ğŸ“‹ ì£¼ìš” ê¸°ëŠ¥:
            // - ëŒ“ê¸€ ì¶”ê°€/ì¡°íšŒ (Google Apps Script API ì—°ë™)
            // - í˜ì´ì§€ë„¤ì´ì…˜ (í•œ í˜ì´ì§€ë‹¹ 10ê°œ)
            // - ìµëª… ëŒ“ê¸€ ì§€ì›
            // - ì‹¤ì‹œê°„ ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ (500ì ì œí•œ)
            // - ì—”í„°í‚¤ë¡œ ëŒ“ê¸€ ì‘ì„± (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
            //
            // ğŸ”§ API ì—”ë“œí¬ì¸íŠ¸:
            // - GET /?action=get - ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ
            // - GET /?action=add&data={...} - ëŒ“ê¸€ ì¶”ê°€
            //
            // ğŸ“ ì‚¬ìš©ë²•:
            // 1. ì•„ë˜ API_URLì„ ì‹¤ì œ Google Apps Script ì›¹ì•± URLë¡œ ë³€ê²½
            // 2. ëŒ“ê¸€ ì‘ì„± ë° ì¡°íšŒ í…ŒìŠ¤íŠ¸
            // 3. í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ëŒ“ê¸€ íƒìƒ‰
            // 4. ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìµœì‹  ëŒ“ê¸€ í™•ì¸
            //
            // âš ï¸ ì¤‘ìš”: API_URLë§Œ ë³€ê²½í•˜ë©´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥!
            //
            // ğŸ’¡ ë°°ìš´ ê²½í—˜ & ì£¼ì˜ì‚¬í•­:
            //
            // ğŸš¨ ë°ì´í„° êµ¬ì¡° ë¬¸ì œ:
            // - Google Sheetsì—ì„œ í—¤ë”ê°€ ì—†ìœ¼ë©´ slice(1)ë¡œ ì²« ì¤„ì„ ì œê±°í•˜ë©´ ì‹¤ì œ ë°ì´í„°ê°€ ì‚¬ë¼ì§
            // - í•´ê²°ì±…: getSheet() í•¨ìˆ˜ì—ì„œ ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ í—¤ë” ìƒì„±
            //
            // ğŸš¨ ì‹œê°„ëŒ€ ë¬¸ì œ:
            // - new Date("2025-08-07 20:31") â†’ 1899-12-30 (ì˜ëª»ëœ íŒŒì‹±)
            // - í•´ê²°ì±…: new Date("2025-08-07T20:31:00") â†’ ì •í™•í•œ íŒŒì‹±
            //
            // ğŸš¨ í•œêµ­ ì‹œê°„ ë¬¸ì œ:
            // - UTC ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œê°€ í•˜ë£¨ ì „ìœ¼ë¡œ ì €ì¥ë¨
            // - í•´ê²°ì±…: getKoreanTime() í•¨ìˆ˜ë¡œ UTC+9 ì ìš©
            //
            // ğŸ”§ ë””ë²„ê¹… íŒ:
            // - ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ debugTime() ì‹¤í–‰
            // - Google Apps Scriptì—ì„œ simpleTest() ì‹¤í–‰
            // - ë°ì´í„° êµ¬ì¡°: [ID, ì‘ì„±ì, ë‚´ìš©, ì‘ì„±ì‹œê°„, ì¢‹ì•„ìš”, ìµëª…ì—¬ë¶€]
            //
            // ğŸ“Š ì„±ëŠ¥ ìµœì í™”:
            // - SpreadsheetApp.flush()ë¡œ ê°•ì œ ì €ì¥
            // - 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
            // - ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ì í”¼ë“œë°±

            // ===== ì„¤ì • - ì—¬ê¸°ì„œ API URLë§Œ ë³€ê²½í•˜ë©´ ë¨ =====
            const API_URL =
                "https://script.google.com/macros/s/AKfycbyR2r2Q7okbXL-rh75n3ge-40ML57FZfrK7d1ZztSGrw9tGUCPG5N1yybfvGAl6PrRTbA/exec";

            // ===== ì „ì—­ ë³€ìˆ˜ =====
            let currentPage = 1; // í˜„ì¬ í˜ì´ì§€
            let commentsPerPage = 10; // í˜ì´ì§€ë‹¹ ëŒ“ê¸€ ìˆ˜
            let allComments = []; // ì „ì²´ ëŒ“ê¸€ ë°ì´í„°

            // ===== DOM ìš”ì†Œë“¤ =====
            const commentList = document.getElementById("commentList");
            const commentInput = document.getElementById("commentInput");
            const commentName = document.getElementById("commentName");
            const anonymousCheck = document.getElementById("anonymousCheck");
            const submitBtn = document.getElementById("submitComment");
            const refreshBtn = document.getElementById("refreshComments");
            const charCount = document.getElementById("charCount");
            const messageDiv = document.getElementById("message");
            const paginationDiv = document.getElementById("commentPagination");
            const prevPageBtn = document.getElementById("prevPage");
            const nextPageBtn = document.getElementById("nextPage");
            const paginationInfo = document.getElementById("paginationInfo");

            // ===== ì´ˆê¸°í™” í•¨ìˆ˜ =====
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ í•¨ìˆ˜
            function init() {
                setupEventListeners(); // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                loadComments(); // ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            }

            // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • =====
            // ëª¨ë“  ì‚¬ìš©ì ì¸í„°ë™ì…˜ì— ëŒ€í•œ ì´ë²¤íŠ¸ ì²˜ë¦¬
            function setupEventListeners() {
                // ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ í´ë¦­
                submitBtn.addEventListener("click", submitComment);

                // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­
                refreshBtn.addEventListener("click", loadComments);

                // ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ (ì‹¤ì‹œê°„)
                commentInput.addEventListener("input", updateCharCount);

                // ì—”í„°í‚¤ë¡œ ëŒ“ê¸€ ì‘ì„± (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
                commentInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        submitComment();
                    }
                });

                // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼
                prevPageBtn.addEventListener("click", () => changePage(-1));
                nextPageBtn.addEventListener("click", () => changePage(1));

                // ìµëª… ì²´í¬ë°•ìŠ¤ ë³€ê²½
                anonymousCheck.addEventListener(
                    "change",
                    handleAnonymousChange
                );
            }

            // ===== ìµëª… ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬ =====
            // ìµëª… ì²´í¬ ì‹œ ì´ë¦„ ì…ë ¥ë€ ë¹„í™œì„±í™”
            function handleAnonymousChange() {
                const nameInput = document.getElementById("commentName");
                if (anonymousCheck.checked) {
                    nameInput.value = "ìµëª…";
                    nameInput.disabled = true;
                } else {
                    nameInput.value = "";
                    nameInput.disabled = false;
                }
            }

            // ===== ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸ =====
            // ì‹¤ì‹œê°„ìœ¼ë¡œ ê¸€ì ìˆ˜ë¥¼ ì¹´ìš´íŠ¸
            function updateCharCount() {
                const count = commentInput.value.length;
                charCount.textContent = count;
            }

            // ===== ëŒ“ê¸€ ì‘ì„± =====
            // ì‚¬ìš©ì ì…ë ¥ì„ ê²€ì¦í•˜ê³  APIë¡œ ëŒ“ê¸€ ì¶”ê°€
            async function submitComment() {
                // ì…ë ¥ê°’ ê²€ì¦
                const content = commentInput.value.trim();
                const author = commentName.value.trim() || "ìµëª…";

                if (!content) {
                    showMessage("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                    return;
                }

                // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ì œì¶œ ë°©ì§€)
                submitBtn.disabled = true;
                submitBtn.textContent = "ì‘ì„± ì¤‘...";

                try {
                    // API í˜¸ì¶œ - ëŒ“ê¸€ ì¶”ê°€
                    const response = await fetch(
                        `${API_URL}?action=add&data=${encodeURIComponent(
                            JSON.stringify({
                                content: content,
                                author: author,
                                isAnonymous: anonymousCheck.checked,
                            })
                        )}`
                    );

                    const result = await response.json();

                    if (result.status === "success") {
                        showMessage("ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");

                        // í¼ ì´ˆê¸°í™”
                        commentInput.value = "";
                        commentName.value = "";
                        anonymousCheck.checked = false;
                        handleAnonymousChange();
                        updateCharCount();

                        // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadComments();
                    } else {
                        showMessage(
                            "ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: " + result.message,
                            "error"
                        );
                    }
                } catch (error) {
                    showMessage("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                } finally {
                    // ë²„íŠ¼ ë³µì›
                    submitBtn.disabled = false;
                    submitBtn.textContent = "ëŒ“ê¸€ ì‘ì„±";
                }
            }

            // ===== ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° =====
            // APIì—ì„œ ëŒ“ê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í™”ë©´ì— í‘œì‹œ
            async function loadComments() {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                commentList.innerHTML =
                    '<div class="loading">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                refreshBtn.disabled = true;
                refreshBtn.textContent = "ë¡œë”© ì¤‘...";

                try {
                    // API í˜¸ì¶œ - ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ
                    const response = await fetch(`${API_URL}?action=get`);
                    const result = await response.json();

                    if (result.status === "success") {
                        allComments = result.comments || [];
                        displayComments();
                        showMessage(
                            `${allComments.length}ê°œì˜ ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`,
                            "success"
                        );
                    } else {
                        commentList.innerHTML =
                            '<div class="error">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' +
                            result.message +
                            "</div>";
                    }
                } catch (error) {
                    commentList.innerHTML =
                        '<div class="error">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                } finally {
                    // ë²„íŠ¼ ë³µì›
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = "ìƒˆë¡œê³ ì¹¨";
                }
            }

            // ===== ëŒ“ê¸€ í‘œì‹œ =====
            // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ëŒ“ê¸€ë“¤ì„ í™”ë©´ì— ë Œë”ë§
            function displayComments() {
                const startIndex = (currentPage - 1) * commentsPerPage;
                const endIndex = startIndex + commentsPerPage;
                const pageComments = allComments.slice(startIndex, endIndex);

                if (pageComments.length === 0) {
                    commentList.innerHTML =
                        '<div class="loading">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    paginationDiv.style.display = "none";
                    return;
                }

                // ëŒ“ê¸€ HTML ìƒì„±
                const commentsHtml = pageComments
                    .map(
                        (comment) => `
                <div class="comment-item">
                    <div class="comment-author">${
                        comment.isAnonymous
                            ? "ìµëª…"
                            : escapeHtml(comment.author)
                    }</div>
                    <div class="comment-content">${escapeHtml(
                        comment.content
                    )}</div>
                    <div class="comment-time">${formatDate(
                        comment.timestamp
                    )}</div>
                </div>
            `
                    )
                    .join("");

                commentList.innerHTML = commentsHtml;
                updatePagination();
            }

            // ===== í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸ =====
            // í˜„ì¬ í˜ì´ì§€ ì •ë³´ì™€ ë²„íŠ¼ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
            function updatePagination() {
                const totalPages = Math.ceil(
                    allComments.length / commentsPerPage
                );

                if (totalPages <= 1) {
                    paginationDiv.style.display = "none";
                    return;
                }

                paginationDiv.style.display = "flex";
                prevPageBtn.disabled = currentPage <= 1;
                nextPageBtn.disabled = currentPage >= totalPages;

                const startItem = (currentPage - 1) * commentsPerPage + 1;
                const endItem = Math.min(
                    currentPage * commentsPerPage,
                    allComments.length
                );

                paginationInfo.textContent = `${startItem}-${endItem} / ${allComments.length}`;
            }

            // ===== í˜ì´ì§€ ë³€ê²½ =====
            // ì´ì „/ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
            function changePage(delta) {
                const newPage = currentPage + delta;
                const totalPages = Math.ceil(
                    allComments.length / commentsPerPage
                );

                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    displayComments();
                }
            }

            // ===== ë©”ì‹œì§€ í‘œì‹œ =====
            // ì„±ê³µ/ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ (5ì´ˆ í›„ ìë™ ì œê±°)
            function showMessage(text, type) {
                messageDiv.textContent = text;
                messageDiv.className = type;

                setTimeout(() => {
                    messageDiv.textContent = "";
                    messageDiv.className = "";
                }, 5000);
            }

            // ===== HTML ì´ìŠ¤ì¼€ì´í”„ =====
            // XSS ê³µê²© ë°©ì§€ë¥¼ ìœ„í•œ HTML íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // ===== ë‚ ì§œ í¬ë§·íŒ… =====
            // ISO ë‚ ì§œë¥¼ í•œêµ­ ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            function formatDate(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleString("ko-KR", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            }

            // ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” =====
            document.addEventListener("DOMContentLoaded", init);
        </script>
    </body>
</html>
